<!DOCTYPE html>
<html>
<head>
    <title>ëŒ€ìš©ëŸ‰ ì˜ìƒ ì—…ë¡œë“œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #status { margin-top: 20px; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2>10GB ì˜ìƒ ì—…ë¡œë“œ (R2 Signed URL ë°©ì‹)</h2>
    <input type="file" id="fileInput" accept="video/*">
    <button onclick="uploadFile()" id="uploadBtn">ì—…ë¡œë“œ ì‹œì‘</button>
    
    <div id="status">ìƒíƒœ: íŒŒì¼ì„ ì„ íƒí•˜ê³  'ì—…ë¡œë“œ ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

    <script>
        // ì´ ì£¼ì†Œë¥¼ ë‹¹ì‹ ì˜ Worker ì„œë¸Œë„ë©”ì¸ ì£¼ì†Œë¡œ ì •í™•íˆ ë³€ê²½í•˜ì„¸ìš”!
        const WORKER_URL = 'https://aespa.igangyun.com'; 
        const fileInput = document.getElementById('fileInput');
        const statusElement = document.getElementById('status');
        const uploadBtn = document.getElementById('uploadBtn');

        async function uploadFile() {
            const file = fileInput.files[0];
            if (!file) {
                alert('ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (file.size > 10 * 1024 * 1024 * 1024) {
                 statusElement.textContent = 'ê²½ê³ : íŒŒì¼ í¬ê¸°ê°€ 10GBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ì—…ë¡œë“œì— ë§¤ìš° ì˜¤ëœ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }

            uploadBtn.disabled = true;
            statusElement.textContent = `1. Signed URL ìš”ì²­ ì¤‘... (íŒŒì¼ëª…: ${file.name})`;
            
            try {
                // 1ë‹¨ê³„: Workerì—ê²Œ Signed URL ìš”ì²­
                const response = await fetch(`${WORKER_URL}/upload-url`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileName: file.name,
                        fileType: file.type || 'application/octet-stream',
                    }),
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Signed URL ìš”ì²­ ì‹¤íŒ¨ (Status: ${response.status}, Error: ${errorBody})`);
                }

                const data = await response.json();
                const { signedUrl, key, publicAccessUrl } = data;

                statusElement.textContent = `2. R2ì— ì§ì ‘ ì—…ë¡œë“œ ì‹œì‘ (Workerë¥¼ ê±°ì¹˜ì§€ ì•ŠìŒ). ì†ë„ëŠ” ì¸í„°ë„· í™˜ê²½ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤...`;

                // 2ë‹¨ê³„: Signed URLì„ ì‚¬ìš©í•˜ì—¬ R2ì— íŒŒì¼ ì§ì ‘ PUT
                const uploadResponse = await fetch(signedUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': file.type || 'application/octet-stream',
                    },
                    body: file,
                });

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    throw new Error(`R2 ì§ì ‘ ì—…ë¡œë“œ ì‹¤íŒ¨ (Status: ${uploadResponse.status}, Error: ${errorText})`);
                }

                statusElement.innerHTML = `
                    <h3>âœ… ì—…ë¡œë“œ ì„±ê³µ!</h3>
                    <p>ì €ì¥ëœ íŒŒì¼ ì´ë¦„: ${key}</p>
                    <p>ë‹¤ìš´ë¡œë“œ ë§í¬: <a href="${publicAccessUrl}" target="_blank">${publicAccessUrl}</a></p>
                `;

            } catch (error) {
                statusElement.textContent = `ğŸš¨ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                console.error(error);
            } finally {
                uploadBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
